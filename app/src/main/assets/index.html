
<!DOCTYPE html>
<html>
<head>
  <title>Leaflet mobile example</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
  <script src="json2.js"></script>
  <style>
    body {
    padding: 0;
    margin: 0;
    }
    html, body, #map {
    height: 100%;
    }
  </style>
</head>
<body>
<div id="map"></div>



<script>

        var collection = {
            "type": "FeatureCollection",
            "features": []
        };


        function reset(){
          window.control.toast();
          map.panTo([getY(), getX()], {animate:true});
        }


        function getX(){
          var x = window.control.getX();
          return x;
        }

        function getY(){
          var y = window.control.getY();
          return y;
        }

        function markKYX_Start(){
          var mark = L.marker(map.getCenter(), {title:'起点'});
          mark.addTo(map);
          mark.on('click', editKYX);
          var geojson = mark.toGeoJSON();
          collection.features.push(geojson);

          var point = map.getCenter();

          //var lat = Math.round(point.lat*100)/100;
         // var lng = Math.round(point.lng*100)/100

          var lat = point.lat;
          var lng = point.lng;

          window.control.writePoint(lat+"", "sPLat");
          window.control.writePoint(lng+"", "sPLong");

        }

        function markKYX_End(){
          var mark = L.marker(map.getCenter(), {title:'起点'});
          mark.addTo(map)
          mark.on('click', editKYX);
          var geojson = mark.toGeoJSON();
          collection.features.push(geojson);


          var point = map.getCenter();

          //var lat = Math.round(point.lat*100)/100;
          //var lng = Math.round(point.lng*100)/100
          var lat = point.lat;
          var lng = point.lng;

          window.control.writePoint(lat+"", "ePLat");
          window.control.writePoint(lng+"", "ePLong");


        }



        function test(x1, y1, x2, y2){

          var polyline = L.polyline([L.latLng(x1, y1), L.latLng(x2, y2)], {color: 'blue'}).addTo(map);
          map.fitBounds(polyline.getBounds());
          polyline.on('click', editKYX);

          collection.features.push(polyline.toGeoJSON());
          window.control.log(JSON.stringify(collection)+"  dudu");
          window.control.saveGeoJson(JSON.stringify(collection));
        }

        function editKYX(){
          window.control.editKuaYueLine();
        }

        var x = getX();
        var y = getY();




        var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

        var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
		    streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});


        var map = L.map('map', {
			center: [y, x],
			zoom: 14,
			layers: [grayscale]
		});

        /*
        获取地理JSON数据,给地图添加覆盖物
        */
		var restoreLayer = function(){
		  var str = window.control.getGeoJson();
		  window.control.log(str);
          var jsonObj = JSON.parse(str);
          window.control.log(jsonObj.type);
          var features = jsonObj.features;
          window.control.log(features.length);
          for(x in features){
            window.control.log(features[x].geometry.type+"<br>");
            if(features[x].geometry.type=="Point"){
              window.control.log(features[x].geometry.coordinates[0]);
              var arr = features[x].geometry.coordinates;
              var mark = L.marker([arr[1], arr[0]]).addTo(map);
              mark.on('click', editKYX);
            } else if(features[x].geometry.type=="LineString"){
              var arr1 = features[x].geometry.coordinates;

              var polyline = L.polyline([ [arr1[0][1],arr1[0][0]], [arr1[1][1],arr1[1][0]] ], {color: 'red'}).addTo(map);
            }
          }
		}

        restoreLayer();


		var baseLayers = {
			"Grayscale": grayscale,
			"Streets": streets
		};

		L.control.layers(baseLayers).addTo(map);


		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);



		/*创建一个弹窗对象*/
    var popup = L.popup();

    function onMapClick(e) {//地图点击监听
        popup
                .setLatLng(e.latlng)//设置当前点击的坐标
                .setContent("你点击的坐标点是" + e.latlng.toString())//设置当前坐标的信息
                .openOn(map);//设置作用的地图
    }

    //map.on('click', onMapClick);//设置点击事件

</script>
</body>
</html>
